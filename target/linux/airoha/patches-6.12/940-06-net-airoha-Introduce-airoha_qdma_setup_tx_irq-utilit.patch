From ce83c1d5f1ef7e51fe9cd3b0a2464d35adb6bc32 Mon Sep 17 00:00:00 2001
Message-ID: <ce83c1d5f1ef7e51fe9cd3b0a2464d35adb6bc32.1770895923.git.lorenzo@kernel.org>
In-Reply-To: <ccbd0dbfe85bcaf7e936240e8f7bab1ccd6486e9.1770895923.git.lorenzo@kernel.org>
References: <ccbd0dbfe85bcaf7e936240e8f7bab1ccd6486e9.1770895923.git.lorenzo@kernel.org>
From: Lorenzo Bianconi <lorenzo@kernel.org>
Date: Thu, 12 Feb 2026 11:27:28 +0100
Subject: [bpf-next 3/7] net: airoha: Introduce airoha_qdma_setup_tx_irq
 utility routine

Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
---
 drivers/net/ethernet/airoha/airoha_eth.c | 22 ++++++++++++++--------
 1 file changed, 14 insertions(+), 8 deletions(-)

--- a/drivers/net/ethernet/airoha/airoha_eth.c
+++ b/drivers/net/ethernet/airoha/airoha_eth.c
@@ -1011,10 +1011,22 @@ static int airoha_qdma_init_tx_queue(str
 	return 0;
 }
 
+static void airoha_qdma_setup_tx_irq(struct airoha_tx_irq_queue *irq_q)
+{
+	struct airoha_qdma *qdma = irq_q->qdma;
+	int id = irq_q - &qdma->q_tx_irq[0];
+
+	memset(irq_q->q, 0xff, irq_q->size * sizeof(u32));
+	airoha_qdma_wr(qdma, REG_TX_IRQ_BASE(id), irq_q->dma_addr);
+	airoha_qdma_rmw(qdma, REG_TX_IRQ_CFG(id), TX_IRQ_DEPTH_MASK,
+			FIELD_PREP(TX_IRQ_DEPTH_MASK, irq_q->size));
+	airoha_qdma_rmw(qdma, REG_TX_IRQ_CFG(id), TX_IRQ_THR_MASK,
+			FIELD_PREP(TX_IRQ_THR_MASK, 1));
+}
+
 static int airoha_qdma_tx_irq_init(struct airoha_tx_irq_queue *irq_q,
 				   struct airoha_qdma *qdma, int size)
 {
-	int id = irq_q - &qdma->q_tx_irq[0];
 	struct airoha_eth *eth = qdma->eth;
 
 	netif_napi_add_tx(eth->napi_dev, &irq_q->napi,
@@ -1024,15 +1036,9 @@ static int airoha_qdma_tx_irq_init(struc
 	if (!irq_q->q)
 		return -ENOMEM;
 
-	memset(irq_q->q, 0xff, size * sizeof(u32));
 	irq_q->size = size;
 	irq_q->qdma = qdma;
-
-	airoha_qdma_wr(qdma, REG_TX_IRQ_BASE(id), irq_q->dma_addr);
-	airoha_qdma_rmw(qdma, REG_TX_IRQ_CFG(id), TX_IRQ_DEPTH_MASK,
-			FIELD_PREP(TX_IRQ_DEPTH_MASK, size));
-	airoha_qdma_rmw(qdma, REG_TX_IRQ_CFG(id), TX_IRQ_THR_MASK,
-			FIELD_PREP(TX_IRQ_THR_MASK, 1));
+	airoha_qdma_setup_tx_irq(irq_q);
 
 	return 0;
 }
