From 922268e12c154cb30d3b10f9395f2925ea61957d Mon Sep 17 00:00:00 2001
Message-ID: <922268e12c154cb30d3b10f9395f2925ea61957d.1770895923.git.lorenzo@kernel.org>
In-Reply-To: <ccbd0dbfe85bcaf7e936240e8f7bab1ccd6486e9.1770895923.git.lorenzo@kernel.org>
References: <ccbd0dbfe85bcaf7e936240e8f7bab1ccd6486e9.1770895923.git.lorenzo@kernel.org>
From: Lorenzo Bianconi <lorenzo@kernel.org>
Date: Thu, 12 Feb 2026 11:20:27 +0100
Subject: [bpf-next 2/7] net: airoha: Add DMA address field to airoha_queue
 struct

Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
---
 drivers/net/ethernet/airoha/airoha_eth.c | 5 ++---
 drivers/net/ethernet/airoha/airoha_eth.h | 1 +
 2 files changed, 3 insertions(+), 3 deletions(-)

--- a/drivers/net/ethernet/airoha/airoha_eth.c
+++ b/drivers/net/ethernet/airoha/airoha_eth.c
@@ -974,7 +974,6 @@ static int airoha_qdma_init_tx_queue(str
 {
 	struct airoha_eth *eth = qdma->eth;
 	int i, qid = q - &qdma->q_tx[0];
-	dma_addr_t dma_addr;
 
 	spin_lock_init(&q->lock);
 	q->ndesc = size;
@@ -988,7 +987,7 @@ static int airoha_qdma_init_tx_queue(str
 		return -ENOMEM;
 
 	q->desc = dmam_alloc_coherent(eth->dev, q->ndesc * sizeof(*q->desc),
-				      &dma_addr, GFP_KERNEL);
+				      &q->desc_addr, GFP_KERNEL);
 	if (!q->desc)
 		return -ENOMEM;
 
@@ -1003,7 +1002,7 @@ static int airoha_qdma_init_tx_queue(str
 	airoha_qdma_set(qdma, REG_TX_RING_BLOCKING(qid),
 			TX_RING_IRQ_BLOCKING_TX_DROP_EN_MASK);
 
-	airoha_qdma_wr(qdma, REG_TX_RING_BASE(qid), dma_addr);
+	airoha_qdma_wr(qdma, REG_TX_RING_BASE(qid), q->desc_addr);
 	airoha_qdma_rmw(qdma, REG_TX_CPU_IDX(qid), TX_RING_CPU_IDX_MASK,
 			FIELD_PREP(TX_RING_CPU_IDX_MASK, 0));
 	airoha_qdma_rmw(qdma, REG_TX_DMA_IDX(qid), TX_RING_DMA_IDX_MASK,
--- a/drivers/net/ethernet/airoha/airoha_eth.h
+++ b/drivers/net/ethernet/airoha/airoha_eth.h
@@ -186,6 +186,7 @@ struct airoha_queue {
 	spinlock_t lock;
 	struct airoha_queue_entry *entry;
 	struct airoha_qdma_desc *desc;
+	dma_addr_t desc_addr;
 	u16 head;
 	u16 tail;
 
