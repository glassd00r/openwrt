From 876e3d6d0cf69e7e9f5582897970e3d98e3312c5 Mon Sep 17 00:00:00 2001
Message-ID: <876e3d6d0cf69e7e9f5582897970e3d98e3312c5.1770895923.git.lorenzo@kernel.org>
In-Reply-To: <ccbd0dbfe85bcaf7e936240e8f7bab1ccd6486e9.1770895923.git.lorenzo@kernel.org>
References: <ccbd0dbfe85bcaf7e936240e8f7bab1ccd6486e9.1770895923.git.lorenzo@kernel.org>
From: Lorenzo Bianconi <lorenzo@kernel.org>
Date: Thu, 12 Feb 2026 12:18:49 +0100
Subject: [bpf-next 6/7] net: airoha: Introduce airoha_qdma_setup_rx_queue
 utility routine

Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
---
 drivers/net/ethernet/airoha/airoha_eth.c | 37 ++++++++++++++----------
 1 file changed, 21 insertions(+), 16 deletions(-)

--- a/drivers/net/ethernet/airoha/airoha_eth.c
+++ b/drivers/net/ethernet/airoha/airoha_eth.c
@@ -773,12 +773,29 @@ static int airoha_qdma_init_rx_pp(struct
 	return 0;
 }
 
+static void airoha_qdma_setup_rx_queue(struct airoha_queue *q)
+{
+	struct airoha_qdma *qdma = q->qdma;
+	int qid = q - &qdma->q_rx[0], thr;
+
+	airoha_qdma_wr(qdma, REG_RX_RING_BASE(qid), q->desc_addr);
+	airoha_qdma_rmw(qdma, REG_RX_RING_SIZE(qid),
+			RX_RING_SIZE_MASK,
+			FIELD_PREP(RX_RING_SIZE_MASK, q->ndesc));
+
+	thr = clamp(q->ndesc >> 3, 1, 32);
+	airoha_qdma_rmw(qdma, REG_RX_RING_SIZE(qid), RX_RING_THR_MASK,
+			FIELD_PREP(RX_RING_THR_MASK, thr));
+	airoha_qdma_rmw(qdma, REG_RX_DMA_IDX(qid), RX_RING_DMA_IDX_MASK,
+			FIELD_PREP(RX_RING_DMA_IDX_MASK, q->head));
+	airoha_qdma_set(qdma, REG_RX_SCATTER_CFG(qid), RX_RING_SG_EN_MASK);
+}
+
 static int airoha_qdma_init_rx_queue(struct airoha_queue *q,
 				     struct airoha_qdma *qdma, int ndesc)
 {
-	int err, qid = q - &qdma->q_rx[0], thr;
 	struct airoha_eth *eth = qdma->eth;
-	dma_addr_t dma_addr;
+	int err;
 
 	q->ndesc = ndesc;
 	q->qdma = qdma;
@@ -793,24 +810,12 @@ static int airoha_qdma_init_rx_queue(str
 		return -ENOMEM;
 
 	q->desc = dmam_alloc_coherent(eth->dev, q->ndesc * sizeof(*q->desc),
-				      &dma_addr, GFP_KERNEL);
+				      &q->desc_addr, GFP_KERNEL);
 	if (!q->desc)
 		return -ENOMEM;
 
 	netif_napi_add(eth->napi_dev, &q->napi, airoha_qdma_rx_napi_poll);
-
-	airoha_qdma_wr(qdma, REG_RX_RING_BASE(qid), dma_addr);
-	airoha_qdma_rmw(qdma, REG_RX_RING_SIZE(qid),
-			RX_RING_SIZE_MASK,
-			FIELD_PREP(RX_RING_SIZE_MASK, ndesc));
-
-	thr = clamp(ndesc >> 3, 1, 32);
-	airoha_qdma_rmw(qdma, REG_RX_RING_SIZE(qid), RX_RING_THR_MASK,
-			FIELD_PREP(RX_RING_THR_MASK, thr));
-	airoha_qdma_rmw(qdma, REG_RX_DMA_IDX(qid), RX_RING_DMA_IDX_MASK,
-			FIELD_PREP(RX_RING_DMA_IDX_MASK, q->head));
-	airoha_qdma_set(qdma, REG_RX_SCATTER_CFG(qid), RX_RING_SG_EN_MASK);
-
+	airoha_qdma_setup_rx_queue(q);
 	airoha_qdma_fill_rx_queue(q);
 
 	return 0;
