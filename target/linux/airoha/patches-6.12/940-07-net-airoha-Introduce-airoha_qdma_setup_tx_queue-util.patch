From ad3b0ca97f56653de54ba9cfcbd81c0caa1197d3 Mon Sep 17 00:00:00 2001
Message-ID: <ad3b0ca97f56653de54ba9cfcbd81c0caa1197d3.1770895923.git.lorenzo@kernel.org>
In-Reply-To: <ccbd0dbfe85bcaf7e936240e8f7bab1ccd6486e9.1770895923.git.lorenzo@kernel.org>
References: <ccbd0dbfe85bcaf7e936240e8f7bab1ccd6486e9.1770895923.git.lorenzo@kernel.org>
From: Lorenzo Bianconi <lorenzo@kernel.org>
Date: Thu, 12 Feb 2026 11:31:52 +0100
Subject: [bpf-next 4/7] net: airoha: Introduce airoha_qdma_setup_tx_queue
 utility routine

Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
---
 drivers/net/ethernet/airoha/airoha_eth.c | 40 +++++++++++++++---------
 1 file changed, 25 insertions(+), 15 deletions(-)

--- a/drivers/net/ethernet/airoha/airoha_eth.c
+++ b/drivers/net/ethernet/airoha/airoha_eth.c
@@ -969,11 +969,38 @@ unlock:
 	return done;
 }
 
+static void airoha_qdma_setup_tx_queue(struct airoha_queue *q)
+{
+	struct airoha_qdma *qdma = q->qdma;
+	int i, qid = q - &qdma->q_tx[0];
+	struct airoha_queue_entry *e;
+	int index;
+
+	for (i = 0; i < q->ndesc; i++) {
+		u32 val = FIELD_PREP(QDMA_DESC_DONE_MASK, 1);
+
+		WRITE_ONCE(q->desc[i].ctrl, cpu_to_le32(val));
+	}
+
+	/* xmit ring drop default setting */
+	airoha_qdma_set(qdma, REG_TX_RING_BLOCKING(qid),
+			TX_RING_IRQ_BLOCKING_TX_DROP_EN_MASK);
+
+	airoha_qdma_wr(qdma, REG_TX_RING_BASE(qid), q->desc_addr);
+
+	e = list_first_entry(&q->tx_list, struct airoha_queue_entry, list);
+	index = e - q->entry;
+	airoha_qdma_rmw(qdma, REG_TX_CPU_IDX(qid), TX_RING_CPU_IDX_MASK,
+			FIELD_PREP(TX_RING_CPU_IDX_MASK, index));
+	airoha_qdma_rmw(qdma, REG_TX_DMA_IDX(qid), TX_RING_DMA_IDX_MASK,
+			FIELD_PREP(TX_RING_DMA_IDX_MASK, index));
+}
+
 static int airoha_qdma_init_tx_queue(struct airoha_queue *q,
 				     struct airoha_qdma *qdma, int size)
 {
 	struct airoha_eth *eth = qdma->eth;
-	int i, qid = q - &qdma->q_tx[0];
+	int i;
 
 	spin_lock_init(&q->lock);
 	q->ndesc = size;
@@ -991,22 +1018,10 @@ static int airoha_qdma_init_tx_queue(str
 	if (!q->desc)
 		return -ENOMEM;
 
-	for (i = 0; i < q->ndesc; i++) {
-		u32 val = FIELD_PREP(QDMA_DESC_DONE_MASK, 1);
-
+	for (i = 0; i < q->ndesc; i++)
 		list_add_tail(&q->entry[i].list, &q->tx_list);
-		WRITE_ONCE(q->desc[i].ctrl, cpu_to_le32(val));
-	}
 
-	/* xmit ring drop default setting */
-	airoha_qdma_set(qdma, REG_TX_RING_BLOCKING(qid),
-			TX_RING_IRQ_BLOCKING_TX_DROP_EN_MASK);
-
-	airoha_qdma_wr(qdma, REG_TX_RING_BASE(qid), q->desc_addr);
-	airoha_qdma_rmw(qdma, REG_TX_CPU_IDX(qid), TX_RING_CPU_IDX_MASK,
-			FIELD_PREP(TX_RING_CPU_IDX_MASK, 0));
-	airoha_qdma_rmw(qdma, REG_TX_DMA_IDX(qid), TX_RING_DMA_IDX_MASK,
-			FIELD_PREP(TX_RING_DMA_IDX_MASK, 0));
+	airoha_qdma_setup_tx_queue(q);
 
 	return 0;
 }
